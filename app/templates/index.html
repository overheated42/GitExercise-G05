<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <title>MMU HORIZON</title>

     <!-- Leaflet CSS & JS -->
     <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
     <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
     <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
</head>
<body>
    <header>
        <!-- Hamburger Menu Container -->
        <div class="hamburger-container">
            <input type="checkbox" id="hamburger-toggle" class="hamburger-toggle">
            <label for="hamburger-toggle" class="hamburger-icon">
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
                <div class="hamburger-line"></div>
            </label>

            <!-- Navigation Menu -->
            <nav class="nav-menu">
                <!-- Faculties -->
                 <div class="dropdown">
                    <a href="#" class="dropdown-toggle">Faculties</a>
                    <ul class="dropdown-menu">
                        <li><a href="#" data-destination="Faculty of Computing and Informatics">Faculty of Computing and Informatics (FCI)</a></li>
                        <li><a href="#" data-destination="Faculty of Creative Multimedia">Faculty of Creative Multimedia (FCM)</a></li>
                        <li><a href="#" data-destination="Faculty of Engineering">Faculty of Engineering (FOE)</a></li>
                        <li><a href="#" data-destination="Faculty of Management">Faculty of Management (FOM)</a></li>
                    </ul>
                </div>

                <!-- Food and Beverages -->
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle">Food and Beverages</a>
                    <ul class="dropdown-menu">
                        <li><a href="#" data-destination="MMU Starbees">MMU Starbees</a></li>
                        <li><a href="#" data-destination="Restoran Haji Tapah Bistro">Restoran Haji Tapah Bistro</a></li>
                        <li><a href="#" data-destination="Deen's Cafe">Deen's Cafe</a></li>
                    </ul>
                </div>


                <!-- Facilities -->
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle">Facilities</a>
                    <ul class="dropdown-menu">
                        <li><a href="#" data-destination="Library">Siti Hasmah Digital Library Multimedia University</a></li>
                        <li><a href="#" data-destination="Dewan Tun Canselor">Dewan Tun Canselor (DTC)</a></li>
                        <li><a href="#" data-destination="Central Lecture Complex">Central Lecture Complex (CLC)</a></li>
                        <li><a href="#" data-destination="STAD Building MMU">Student Affairs Division (STAD)</a></li>
                        <li><a href="#" data-destination="Surau Al Hidayah MMU">Surau Al Hidayah MMU</a></li>
                    </ul>
                </div>
                
                <!-- Submenu Items -->
                <div class="submenu">
                    <a href="#hostel">Hostel</a>
                    <a href="{{ url_for('auth.account') }}">Account</a>
                    <a href="{{ url_for('auth.logout') }}">Logout</a>
                </div>
            </nav>

            <!-- Close button overlay -->
            <label for="hamburger-toggle" class="menu-overlay"></label>
        </div>

        <h1>LOST IN MMU?</h1>
    </header>

    <!-- Chatbox Container -->
    <div class="chatbox-container">
        <input type="checkbox" id="chatbox-toggle" class="chatbox-toggle">
        
        <!-- Chat Button (floating) -->
        <label for="chatbox-toggle" class="chat-button">
            <div class="chat-icon">üí¨</div>
            <div class="close-icon">‚úï</div>
        </label>

        <!-- Chat Window -->
        <div class="chat-window">
            <div class="chat-header">
                <h3>MMU AI Assistant</h3>
                <label for="chatbox-toggle" class="chat-close">‚úï</label>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    <div class="message-content">Hello! I'm your MMU AI assistant. I can help you with information about faculties, facilities, food options, and general campus queries. How can I help you today?</div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <form class="chat-form" id="chatForm" onsubmit="sendMessage(event)">
                    <input type="text" class="chat-input" id="messageInput" name="message" placeholder="Type your message here..." required>
                    <button type="submit" class="send-button" id="sendButton">Send</button>
                </form>
            </div>
        </div>

        <!-- Chat Overlay -->
        <label for="chatbox-toggle" class="chat-overlay"></label>
    </div>

    <!-- Enhanced JavaScript for chat functionality -->
    <script>
        let isRequestInProgress = false;

        function sendMessage(event) {
            event.preventDefault();
            
            // Prevent multiple simultaneous requests
            if (isRequestInProgress) return;
            
            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (message === '') return;
            
            // Set request in progress
            isRequestInProgress = true;
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';
            
            // Add user message to chat
            const chatMessages = document.getElementById('chatMessages');
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message user-message';
            userMessageDiv.innerHTML = `<div class="message-content">${escapeHtml(message)}</div>`;
            chatMessages.appendChild(userMessageDiv);
            
            // Clear input
            input.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `<div class="message-content">
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
                AI is thinking...
            </div>`;
            chatMessages.appendChild(typingDiv);
            
            // Scroll to bottom
            scrollToBottom();
            
            // Send message to server (supports both JSON and form data)
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Remove typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                // Add AI response with proper HTML handling
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'message ai-message';
                
                // Handle potential HTML/markdown in response
                const formattedResponse = formatAIResponse(data.response);
                aiMessageDiv.innerHTML = `<div class="message-content">${formattedResponse}</div>`;
                chatMessages.appendChild(aiMessageDiv);
                
                scrollToBottom();
            })
            .catch(error => {
                console.error('Chat error:', error);
                
                // Remove typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                
                // Show appropriate error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message ai-message error-message';
                
                let errorMessage = "Sorry, I'm having trouble connecting right now. Please try again in a moment.";
                if (error.message.includes('500')) {
                    errorMessage = "The AI service is temporarily unavailable. Our basic help system is still working - try asking about faculties, food, or facilities!";
                } else if (error.message.includes('404')) {
                    errorMessage = "Hmm, seems like there's a connection issue. Please refresh the page and try again.";
                }
                
                errorDiv.innerHTML = `<div class="message-content">${errorMessage}</div>`;
                chatMessages.appendChild(errorDiv);
                
                scrollToBottom();
            })
            .finally(() => {
                // Reset button state
                isRequestInProgress = false;
                sendButton.disabled = false;
                sendButton.textContent = 'Send';
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatAIResponse(response) {
            // Basic formatting for better display
            return response
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italic
                .replace(/\n\n/g, '<br><br>') // Paragraph breaks
                .replace(/\n/g, '<br>') // Line breaks
                .replace(/‚Ä¢/g, '‚Ä¢'); // Ensure bullets display correctly
        }

        function scrollToBottom() {
            const chatMessages = document.getElementById('chatMessages');
            setTimeout(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 100);
        }

        // Allow sending message with Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(e);
            }
        });

        // Auto-focus input when chat is opened
        document.getElementById('chatbox-toggle').addEventListener('change', function(e) {
            if (e.target.checked) {
                setTimeout(() => {
                    document.getElementById('messageInput').focus();
                }, 300);
            }
        });
    </script>


    <main>
        <div id="map"></div>
        <div id="sidebar-overlay">
            <input type="text" id="searchInput" placeholder="Search">
            <div id="suggestionBox"></div>
            <div id="route-info" style="display:none;"></div> 
          </div>
    </main>

    <!-- FCI Information Modal -->
    <div class="modal-overlay" id="fciModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-content">
                    <h2>Faculty of Computing and Informatics</h2>
                    <p>Shaping the Future of Technology</p>
                </div>
                <button class="close-button" onclick="closeFCIModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="info-section">
                    <h3>About FCI</h3>
                    <p>The Faculty of Computing and Informatics (FCI) at Multimedia University is a leading institution in technology education, dedicated to producing innovative and skilled graduates in the fields of computing, software engineering, and information systems.</p>
                    <p>Established with a vision to advance technological innovation, FCI combines theoretical knowledge with practical application, ensuring our students are industry-ready and equipped with cutting-edge skills.</p>
                </div>

                <div class="info-section">
                    <h3>Programs Offered</h3>
                    <div class="programs-grid">
                        <div class="program-card">
                            <h4>üñ•Ô∏è Bachelor of Computer Science</h4>
                            <p>Comprehensive program covering algorithms, data structures, AI, and machine learning.</p>
                        </div>
                        <div class="program-card">
                            <h4>üíª Software Engineering</h4>
                            <p>Focuses on designing and developing software systems with innovative methodologies and sophisticated tools. Students are exposed to various techniques of analysing user requirements and specifications, as well as the design, implementation and verification of software system.</p>
                        </div>
                        <div class="program-card">
                            <h4>üîí Cybersecurity</h4>
                            <p>Built on the technical foundation of computer science, the specialization focuses on the array of sophisticated techniques and innovative approaches used to protect data and information systems. Students are exposed to both offensive and defensive security methodologies such as ethical hacking, digital forensics and network security, as well as policies and ethical issues of cybersecurity.</p>
                        </div>
                        <div class="program-card">
                            <h4>üìä Data Science</h4>
                            <p>Drawing upon the technical foundation of computer science, this specialization focuses on designing and developing solutions to extract valuable insights from data. Students are exposed with fundamental theories in data science as well as hands-on experience in building practical solutions.</p>
                        </div>
                        <div class="program-card">
                            <h4>üì± Game Development</h4>
                            <p>Integrates fundamental concepts of software engineering with both technical and creative aspects of game design and development. Students are exposed to various types of game production ‚Äì from 2D to 3D, and from virtual to augmented reality game projects.</p>
                        </div>
                        <div class="program-card">
                            <h4>üåê Information Systems</h4>
                            <p>Business applications, database management, and enterprise solutions.</p>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>Facilities & Highlights</h3>
                    <p>‚Ä¢ <strong>State-of-the-art computer labs</strong> with latest hardware and software</p>
                    <p>‚Ä¢ <strong>Research centers</strong> for AI, cybersecurity, and data analytics</p>
                    <p>‚Ä¢ <strong>Industry partnerships</strong> providing internship and career opportunities</p>
                    <p>‚Ä¢ <strong>Innovation labs</strong> for student projects and startup incubation</p>
                    <p>‚Ä¢ <strong>Experienced faculty</strong> with industry and academic expertise</p>
                </div>

                <div class="contact-info">
                    <h4>üìç Contact Information</h4>
                    <p><strong>Location:</strong> FCI Building, MMU Cyberjaya Campus</p>
                    <p><strong>Office Hours:</strong> Monday - Friday, 8:00 AM - 5:00 PM</p>
                    <p><strong>Email:</strong> fci@mmu.edu.my</p>
                    <p><strong>Phone:</strong> +603-8312-5000</p>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="navigateToFCI()">
                        üó∫Ô∏è Get Directions
                    </button>
                    <button class="btn btn-secondary" onclick="viewPrograms()">
                        üìö View All Programs
                    </button>
                    <button class="btn btn-secondary" onclick="contactFCI()">
                        üìû Contact FCI
                    </button>
                </div>
            </div>
        </div>
    </div>

     <!-- Leaflet Routing Machine -->
     <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
     <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
     <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
     <script src="https://unpkg.com/leaflet-geometryutil"></script> <!-- helper -->
        
     <script src="static/scripts.js"></script>
    
      
    
</body>
</html>